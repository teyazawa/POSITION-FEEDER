<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Position / Feeder Board</title>

  <link rel="stylesheet" href="https://unpkg.com/vis-timeline@latest/styles/vis-timeline-graph2d.min.css">
  <script src="https://unpkg.com/vis-data@latest/peer/umd/vis-data.min.js"></script>
  <script src="https://unpkg.com/vis-timeline@latest/peer/umd/vis-timeline-graph2d.min.js"></script>

  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", sans-serif; margin: 0; }
    header { padding: 12px 16px; border-bottom: 1px solid #ddd; display: flex; gap: 12px; align-items: center; }
    #wrap { display: grid; grid-template-columns: 320px 1fr; height: calc(100vh - 50px); }
    #left { border-right: 1px solid #ddd; padding: 12px; overflow: auto; }
    #timeline { height: 100%; }
    .row { margin-bottom: 10px; }
    label { display:block; font-size: 12px; color: #444; margin-bottom: 4px; }
    input, select { width: 100%; padding: 8px; box-sizing: border-box; }
    .doneItem { opacity: 0.35; }
  </style>
</head>

<body>
<header>
  <strong>盤面</strong>
  <button id="btnReload">再読込</button>
</header>

<div id="wrap">
  <div id="left">
    <div class="row">
      <label>表示開始</label>
      <input id="startDate" type="date" />
    </div>
    <div class="row">
      <label>表示終了</label>
      <input id="endDate" type="date" />
    </div>
    <div class="row">
      <label>ステータス</label>
      <select id="statusFilter">
        <option value="">すべて</option>
        <option value="open">未完了</option>
        <option value="done">完了</option>
      </select>
    </div>
    <div class="row">
      <label>ルート検索（部分一致）</label>
      <input id="routeFilter" placeholder="例：青海→大井" />
    </div>
  </div>

  <div id="timeline"></div>
</div>

<script>
  // ====== ここだけ差し替え ======
  const GAS_URL = 'https://script.google.com/macros/s/AKfycbx5HV_menEoAEihgvJDfAkwePogYodNlNY8Okgxd2rbvBvmBID18dm_2N8fqXhknOI43A/exec';
  const TOKEN  = 'OOIPOSITIONFEEDER';

  let timeline;

  function toDate(d) {
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth()+1).padStart(2,'0');
    const dd = String(d.getDate()).padStart(2,'0');
    return `${yyyy}-${mm}-${dd}`;
  }

  function initDefaults() {
    const today = new Date();
    const start = new Date(today); start.setDate(today.getDate()-7);
    const end   = new Date(today); end.setDate(today.getDate()+21);

    document.getElementById('startDate').value = toDate(start);
    document.getElementById('endDate').value   = toDate(end);
  }

  async function listOrders() {
    const start = document.getElementById('startDate').value;
    const end   = document.getElementById('endDate').value;

    const url = new URL(GAS_URL);
    url.searchParams.set('token', TOKEN);
    url.searchParams.set('action', 'listOrders');
    url.searchParams.set('start_date', start);
    url.searchParams.set('end_date', end);

    const res = await fetch(url.toString());
    const json = await res.json();
    if (!json.ok) throw new Error(json.error || 'listOrders_failed');
    return json.data || [];
  }

  function buildTimeline(orders) {
    const statusFilter = document.getElementById('statusFilter').value;
    const routeFilter  = document.getElementById('routeFilter').value.trim();

    const filtered = orders.filter(o => {
      if (statusFilter && String(o.status) !== statusFilter) return false;
      if (routeFilter && !String(o.route || '').includes(routeFilter)) return false;
      return true;
    });

    // groups: route単位
    const routeSet = new Map();
    filtered.forEach(o => routeSet.set(o.route || '(未設定)', true));
    const groupArr = Array.from(routeSet.keys()).sort().map(r => ({ id: r, content: r }));

    const groups = new vis.DataSet(groupArr);

    const itemArr = filtered.map(o => {
      const start = o.start_date ? String(o.start_date) : String(o.due_date || '');
      const end   = o.due_date ? String(o.due_date) : start;

      const done = Number(o.qty_done || 0);
      const total = Number(o.qty_total || 0);
      const remaining = Number(o.qty_remaining || Math.max(total - done, 0));

      const content = `${o.customer || ''} ${o.order_no || ''}<br>${done}/${total}（残${remaining}）`;

      return {
        id: o.order_id,
        group: o.route || '(未設定)',
        start, end,
        content,
        className: (String(o.status) === 'done') ? 'doneItem' : ''
      };
    });

    const items = new vis.DataSet(itemArr);

    const container = document.getElementById('timeline');
    const options = { stack: true };

    if (timeline) timeline.destroy();
    timeline = new vis.Timeline(container, items, groups, options);
  }

  async function reload() {
    const orders = await listOrders();
    buildTimeline(orders);
  }

  document.getElementById('btnReload').addEventListener('click', () => reload().catch(alert));
  document.getElementById('statusFilter').addEventListener('change', () => reload().catch(alert));
  document.getElementById('routeFilter').addEventListener('input', () => reload().catch(alert));

  initDefaults();
  reload().catch(err => {
    console.error(err);
    alert('ロード失敗。GAS URL / TOKEN / デプロイ設定を確認してください。\n' + err.message);
  });
</script>
</body>
</html>
