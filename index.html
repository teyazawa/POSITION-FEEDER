<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Position / Feeder Board</title>

  <link rel="stylesheet" href="https://unpkg.com/vis-timeline@latest/styles/vis-timeline-graph2d.min.css">
  <script src="https://unpkg.com/vis-timeline@latest/standalone/umd/vis-timeline-graph2d.min.js"></script>

  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", sans-serif; margin: 0; }
    header { padding: 12px 16px; border-bottom: 1px solid #ddd; display: flex; gap: 12px; align-items: center; }
    header .spacer { flex: 1; }
    #wrap { display: grid; grid-template-columns: 360px 1fr; height: calc(100vh - 50px); }
    #left { border-right: 1px solid #ddd; padding: 12px; overflow: auto; }
    #timeline { height: 100%; }
    .row { margin-bottom: 10px; }
    label { display:block; font-size: 12px; color: #444; margin-bottom: 4px; }
    input, select, textarea { width: 100%; padding: 8px; box-sizing: border-box; }
    button { padding: 8px 10px; }
    .doneItem { opacity: 0.35; }
    .muted { color: #666; font-size: 12px; }

    /* 残あり + 期限1日以内 */
.urgentItem {
  background: #d32f2f !important;
  border-color: #b71c1c !important;
  color: #fff !important;
}
.urgentItem .vis-item-content {
  color: #fff !important;
}

    dialog { width: min(1100px, 96vw); border: 1px solid #ccc; border-radius: 10px; padding: 0; }
    dialog header { border-bottom: 1px solid #eee; }
    dialog .content { padding: 12px 16px; display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    dialog .footer { padding: 12px 16px; border-top: 1px solid #eee; display:flex; justify-content:flex-end; gap: 8px; }
    .span2 { grid-column: span 2; }

    table { width: 100%; border-collapse: collapse; font-size: 12px; }
    th, td { border-bottom: 1px solid #eee; padding: 6px 4px; text-align: left; vertical-align: middle; }
    .mini { padding: 6px; }
    .btnSmall { padding: 6px 8px; font-size: 12px; }
  </style>
</head>

<body>
<header>
  <strong>盤面</strong>
  <button id="btnReload">再読込</button>
  <button id="btnNew">新規案件</button>
  <div class="spacer"></div>
  <span class="muted" id="statusText"></span>
</header>

<div id="wrap">
  <div id="left">
    <div class="row">
      <label>表示開始</label>
      <input id="startDate" type="date" />
    </div>
    <div class="row">
      <label>表示終了</label>
      <input id="endDate" type="date" />
    </div>

    <div class="row">
      <label>ステータス</label>
      <select id="statusFilter">
        <option value="">すべて</option>
        <option value="open">未完了</option>
        <option value="done">完了</option>
      </select>
    </div>

    <div class="row">
      <label>ルート</label>
      <select id="routeFilterSel"></select>
    </div>

    <div class="row">
      <label>依頼主</label>
      <select id="customerFilterSel"></select>
    </div>

    <div class="row">
      <label>
        <input type="checkbox" id="includeOldDone">
        完了（3か月超）も表示
      </label>
    </div>
  </div>

  <div id="timeline"></div>
</div>

<dialog id="dlg">
  <header>
    <div style="padding:12px 16px; display:flex; align-items:center; gap:12px;">
      <strong id="dlgTitle">案件</strong>
      <span class="muted" id="dlgSub"></span>
      <div class="spacer"></div>
      <button id="btnClose" type="button">閉じる</button>
    </div>
  </header>

  <div class="content">
    <div class="row">
      <label>依頼主</label>
      <select id="f_customer"></select>
    </div>

    <div class="row"><label>受注番号</label><input id="f_order_no"></div>
    <div class="row"><label>本船</label><input id="f_vessel"></div>
    <div class="row"><label>BL/BK</label><input id="f_bl_bk"></div>

    <div class="row">
      <label>搬出 地域</label>
      <select id="f_from_area"></select>
    </div>
    <div class="row">
      <label>搬出 ヤード</label>
      <select id="f_from_yard"></select>
    </div>

    <div class="row">
      <label>搬入 地域</label>
      <select id="f_to_area"></select>
    </div>
    <div class="row">
      <label>搬入 ヤード</label>
      <select id="f_to_yard"></select>
    </div>

    <div class="row"><label>ルート（空なら自動生成）</label><input id="f_route" placeholder="例：青海A-1→南本牧"></div>
    <div class="row"><label>期限日</label><input id="f_due_date" type="date"></div>
    <div class="row"><label>開始日（表示用）</label><input id="f_start_date" type="date"></div>
    <div class="row"><label>メモ</label><input id="f_memo"></div>

    <div class="row span2" style="border-top:1px solid #eee; padding-top:12px;">
      <div style="display:flex; align-items:center; justify-content:space-between; gap:12px;">
        <div>
          <strong>内訳（サイズ×種類×本数）</strong>
          <div class="muted">同一案件内に複数行で登録できます（バーは増えません）。</div>
        </div>
        <button class="btnSmall" id="btnAddLine" type="button">内訳行を追加</button>
      </div>

      <div style="margin-top:8px; overflow:auto;">
        <table>
          <thead>
            <tr>
              <th style="width:140px;">サイズ</th>
              <th style="width:200px;">種類</th>
              <th style="width:120px;">総本数</th>
              <th>メモ</th>
              <th style="width:80px;"></th>
            </tr>
          </thead>
          <tbody id="linesBody"></tbody>
        </table>
      </div>

      <div class="muted" id="linesTotalText" style="margin-top:6px;">合計: -</div>
    </div>

    <div class="row span2" style="border-top:1px solid #eee; padding-top:12px;">
      <strong>当日完了入力（内訳行を選択）</strong>
      <div class="muted">完了は内訳単位で積み上げます（残本数が正確になります）。</div>
    </div>

    <div class="row"><label>作業日</label><input id="f_work_date" type="date"></div>
    <div class="row"><label>内訳行</label><select id="f_done_line"></select></div>

    <div class="row"><label>当日完了本数</label><input id="f_qty_done_today" type="number" min="0"></div>
    <div class="row"><label>進捗（合計）</label><div class="muted" id="progressText">-</div></div>
  </div>

  <div class="footer">
    <button id="btnSave" type="button">保存</button>
    <button id="btnAddDone" type="button">当日完了を追加</button>
  </div>
</dialog>

<script>
  /************ 設定（ここだけ差し替え） ************/
  const GAS_URL = 'https://script.google.com/macros/s/AKfycbx5HV_menEoAEihgvJDfAkwePogYodNlNY8Okgxd2rbvBvmBID18dm_2N8fqXhknOI43A/exec';
  const TOKEN  = 'pf_2026_01_16';

  /************ 状態 ************/
  let timeline;
  let allOrders = [];
  let masters = null;

  let currentOrder = null;     // order object
  let currentLines = [];       // [{line_id,size,container_type,qty_total,memo, qty_done, qty_remaining}]

  /************ Utils ************/
  function toDate(d) {
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth()+1).padStart(2,'0');
    const dd = String(d.getDate()).padStart(2,'0');
    return `${yyyy}-${mm}-${dd}`;
  }
  function addDays(ymd, days) {
    const d = new Date(ymd + 'T00:00:00');
    d.setDate(d.getDate() + days);
    return toDate(d);
  }

  function jsonp(url) {
    return new Promise((resolve, reject) => {
      const cb = 'cb_' + Math.random().toString(36).slice(2);
      url.searchParams.set('callback', cb);

      const script = document.createElement('script');
      script.src = url.toString();

      window[cb] = (data) => { cleanup(); resolve(data); };
      script.onerror = () => { cleanup(); reject(new Error('jsonp_load_failed')); };

      function cleanup() {
        try { delete window[cb]; } catch (_) {}
        script.remove();
      }
      document.head.appendChild(script);
    });
  }

  async function api(action, payloadObj) {
    const url = new URL(GAS_URL);
    url.searchParams.set('token', TOKEN);
    url.searchParams.set('action', action);
    if (payloadObj) url.searchParams.set('payload', JSON.stringify(payloadObj));

    const resp = await jsonp(url);
    if (!resp.ok) throw new Error(resp.error || 'api_error');
    return resp.data;
  }

  function setOptions(selectEl, options, placeholder) {
    selectEl.innerHTML = '';
    const opt0 = document.createElement('option');
    opt0.value = '';
    opt0.textContent = placeholder || 'すべて';
    selectEl.appendChild(opt0);

    for (const v of options) {
      const opt = document.createElement('option');
      opt.value = v;
      opt.textContent = v;
      selectEl.appendChild(opt);
    }
  }

  function uniqueStable(arr) {
    const seen = new Set();
    const out = [];
    for (const v of arr) {
      const s = String(v || '').trim();
      if (!s || seen.has(s)) continue;
      seen.add(s);
      out.push(s);
    }
    return out;
  }

  function refreshLeftFilters(orders) {
    const routes = uniqueStable(orders.map(o => o.route || '(未設定)'));
    setOptions(document.getElementById('routeFilterSel'), routes, 'すべて');
    setOptions(document.getElementById('customerFilterSel'), (masters?.customers || []), 'すべて');
  }

  function findAreaForYard(yard) {
    const y = String(yard || '').trim();
    if (!y) return '';
    const m = masters?.yardsByArea || {};
    for (const area of Object.keys(m)) {
      if ((m[area] || []).includes(y)) return area;
    }
    return '';
  }

  /************ Load ************/
  function initDefaults() {
    const today = new Date();
    const start = new Date(today); start.setDate(today.getDate()-7);
    const end   = new Date(today); end.setDate(today.getDate()+21);

    document.getElementById('startDate').value = toDate(start);
    document.getElementById('endDate').value   = toDate(end);
    document.getElementById('f_work_date').value = toDate(today);
  }

  async function loadMasters() {
    masters = await api('listMasters');

    setOptions(document.getElementById('f_customer'), masters.customers || [], '選択してください');

    setOptions(document.getElementById('f_from_area'), masters.yardAreas || [], '地域を選択');
    setOptions(document.getElementById('f_to_area'), masters.yardAreas || [], '地域を選択');

    setOptions(document.getElementById('f_from_yard'), [], 'ヤードを選択');
    setOptions(document.getElementById('f_to_yard'), [], 'ヤードを選択');
  }

  async function loadOrders() {
    const start = document.getElementById('startDate').value;
    const end   = document.getElementById('endDate').value;

    const includeOldDone = document.getElementById('includeOldDone').checked;

    const url = new URL(GAS_URL);
    url.searchParams.set('token', TOKEN);
    url.searchParams.set('action', 'listOrders');
    url.searchParams.set('start_date', start);
    url.searchParams.set('end_date', end);
    url.searchParams.set('include_old_done', includeOldDone ? '1' : '0');

    const resp = await jsonp(url);
    if (!resp.ok) throw new Error(resp.error || 'listOrders_failed');
    return resp.data || [];
  }

  /************ Timeline ************/
  function buildTimeline(orders) {
    const statusFilter = document.getElementById('statusFilter').value;
    const routeFilter = document.getElementById('routeFilterSel').value;
    const customerFilter = document.getElementById('customerFilterSel').value;

    const filtered = orders.filter(o => {
      if (statusFilter && String(o.status) !== statusFilter) return false;
      if (routeFilter && String(o.route || '') !== routeFilter) return false;
      if (customerFilter && String(o.customer || '') !== customerFilter) return false;
      return true;
    });

    // groups: keep stable order (no sort)
    const routes = uniqueStable(filtered.map(o => o.route || '(未設定)'));
    const groupArr = routes.map(r => ({ id: r, content: r }));
    const groups = new vis.DataSet(groupArr);

    const itemArr = filtered.map(o => {
      const start = o.start_date ? String(o.start_date) : String(o.due_date || '');
      const due = o.due_date ? String(o.due_date) : start;
      const endExclusive = due ? addDays(due, 1) : start;

      const done = Number(o.qty_done || 0);
      const total = Number(o.qty_total || 0);
      const remaining = Number(o.qty_remaining || Math.max(total - done, 0));

      const dueYmd = String(o.due_date || '');
const today = new Date();
today.setHours(0,0,0,0);

let daysLeft = 9999;
if (dueYmd) {
  const due = new Date(dueYmd + 'T00:00:00');
  due.setHours(0,0,0,0);
  daysLeft = Math.floor((due - today) / (24 * 60 * 60 * 1000));
}

const isUrgent = (remaining > 0 && daysLeft <= 1); // 期限が今日(0) or 明日(1) まで

      const lines = (o.lines || []).map(l => {
        const key = `${l.size}/${l.container_type}`;
        return `${key}: ${Number(l.qty_done||0)}/${Number(l.qty_total||0)}（残${Number(l.qty_remaining||0)}）`;
      }).join('\n');

      const content = `${o.customer || ''} ${o.order_no || ''}<br>${done}/${total}（残${remaining}）`;
      const cls = [];
      if (String(o.status) === 'done') cls.push('doneItem');
      if (isUrgent) cls.push('urgentItem');

      return {
        id: o.order_id,
        group: o.route || '(未設定)',
        start,
        end: endExclusive,
        content,
        title: lines,
        className: cls.join(' ')
      };
    });

    const items = new vis.DataSet(itemArr);

    const container = document.getElementById('timeline');

// 表示範囲（UIの開始/終了）を基準に、日幅を“半分くらい”にするためレンジを2倍に圧縮表示
const startInput = document.getElementById('startDate').value; // YYYY-MM-DD
const endInput   = document.getElementById('endDate').value;   // YYYY-MM-DD

const dayMs = 24 * 60 * 60 * 1000;
const winStartBase = new Date(startInput + 'T00:00:00');
const winEndBase   = new Date(endInput + 'T00:00:00');

// end は表示上、最終日を含めたいので +1日（endは排他的扱い）
const winEndBaseExclusive = new Date(winEndBase.getTime() + dayMs);

// レンジ（日数）
const rangeDays = Math.max(1, Math.round((winEndBaseExclusive - winStartBase) / dayMs));

// 「1日間隔を今の4時間間隔の半分くらい」＝見た目を圧縮（レンジを約2倍）
// → 前後に rangeDays/2 ずつ余白を足す
const padDays = Math.round(rangeDays * 0.8);

const windowStart = new Date(winStartBase.getTime() - padDays * dayMs);
const windowEnd   = new Date(winEndBaseExclusive.getTime() + padDays * dayMs);

const options = {
  stack: true,

  // 1日単位に固定（時間目盛りを出さない）
  timeAxis: { scale: 'day', step: 1 },
  format: {
    minorLabels: { day: 'MM/DD（ddd）' },
    majorLabels: { day: 'YYYY年M月' }
  },

  // ホイールズーム無効（前に入れた設定）
  zoomable: false,
  zoomKey: null,
  moveable: true,

  // 表示レンジを固定（ここで日幅が決まる）
  start: windowStart,
  end: windowEnd
};

if (timeline) timeline.destroy();
timeline = new vis.Timeline(container, items, groups, options);

    timeline.on('select', props => {
      if (!props.items || props.items.length === 0) return;
      const id = props.items[0];
      const o = filtered.find(x => String(x.order_id) === String(id));
      if (o) openDialog(o);
    });

    document.getElementById('statusText').textContent =
      `表示 ${filtered.length}件 / 読込 ${orders.length}件`;
  }

  async function reload() {
    document.getElementById('statusText').textContent = '読込中...';
    allOrders = await loadOrders();
    refreshLeftFilters(allOrders);
    buildTimeline(allOrders);
  }

  /************ Dependent yard dropdown ************/
  function updateYards(selectAreaEl, selectYardEl) {
    const area = selectAreaEl.value;
    const list = (masters && masters.yardsByArea && masters.yardsByArea[area]) ? masters.yardsByArea[area] : [];
    setOptions(selectYardEl, list, 'ヤードを選択');
  }

  /************ Lines UI ************/
  function renderLines() {
    const body = document.getElementById('linesBody');
    body.innerHTML = '';

    const sizes = (masters && masters.sizes) ? masters.sizes : [];
    const ctypes = (masters && masters.containerTypes) ? masters.containerTypes : [];

    currentLines.forEach((ln, idx) => {
      const tr = document.createElement('tr');

      const tdSize = document.createElement('td');
      const selSize = document.createElement('select');
      selSize.className = 'mini';
      setOptions(selSize, sizes, '選択');
      selSize.value = ln.size || '';
      selSize.onchange = () => { ln.size = selSize.value; updateLinesTotalAndDoneSelect(); };
      tdSize.appendChild(selSize);

      const tdType = document.createElement('td');
      const selType = document.createElement('select');
      selType.className = 'mini';
      setOptions(selType, ctypes, '選択');
      selType.value = ln.container_type || '';
      selType.onchange = () => { ln.container_type = selType.value; updateLinesTotalAndDoneSelect(); };
      tdType.appendChild(selType);

      const tdQty = document.createElement('td');
      const inpQty = document.createElement('input');
      inpQty.type = 'number';
      inpQty.min = '0';
      inpQty.className = 'mini';
      inpQty.value = (ln.qty_total ?? 0);
      inpQty.oninput = () => { ln.qty_total = Number(inpQty.value || 0); updateLinesTotalAndDoneSelect(); };
      tdQty.appendChild(inpQty);

      const tdMemo = document.createElement('td');
      const inpMemo = document.createElement('input');
      inpMemo.className = 'mini';
      inpMemo.value = ln.memo || '';
      inpMemo.oninput = () => { ln.memo = inpMemo.value; };
      tdMemo.appendChild(inpMemo);

      const tdRm = document.createElement('td');
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'btnSmall';
      btn.textContent = '削除';
      btn.onclick = () => {
        currentLines.splice(idx, 1);
        if (currentLines.length === 0) addLine();
        renderLines();
      };
      tdRm.appendChild(btn);

      tr.appendChild(tdSize);
      tr.appendChild(tdType);
      tr.appendChild(tdQty);
      tr.appendChild(tdMemo);
      tr.appendChild(tdRm);

      body.appendChild(tr);
    });

    updateLinesTotalAndDoneSelect();
  }

  function addLine(defaults) {
    currentLines.push({
      line_id: (defaults && defaults.line_id) ? defaults.line_id : '',
      size: (defaults && defaults.size) ? defaults.size : '',
      container_type: (defaults && defaults.container_type) ? defaults.container_type : '',
      qty_total: (defaults && defaults.qty_total != null) ? Number(defaults.qty_total) : 0,
      memo: (defaults && defaults.memo) ? defaults.memo : '',
      qty_done: (defaults && defaults.qty_done != null) ? Number(defaults.qty_done) : 0,
      qty_remaining: (defaults && defaults.qty_remaining != null) ? Number(defaults.qty_remaining) : 0
    });
  }

  function updateLinesTotalAndDoneSelect() {
    const total = currentLines.reduce((a, b) => a + Number(b.qty_total || 0), 0);
    const done = currentLines.reduce((a, b) => a + Number(b.qty_done || 0), 0);
    const remaining = Math.max(total - done, 0);

    document.getElementById('linesTotalText').textContent = `合計: ${total} 本`;
    document.getElementById('progressText').textContent = `完了 ${done} / ${total}（残 ${remaining}）`;

    const sel = document.getElementById('f_done_line');
    sel.innerHTML = '';
    currentLines.forEach(ln => {
      const key = `${ln.size || '?'} / ${ln.container_type || '?'}`;
      const opt = document.createElement('option');
      opt.value = ln.line_id || '';
      const rem = (ln.qty_remaining != null) ? ln.qty_remaining : Math.max(Number(ln.qty_total||0) - Number(ln.qty_done||0), 0);
      opt.textContent = `${key}（残 ${rem}）`;
      sel.appendChild(opt);
    });
  }

  /************ Dialog ************/
  function openDialog(order) {
    currentOrder = order ? { ...order } : {
      order_id: '',
      customer: '',
      order_no: '',
      vessel: '',
      bl_bk: '',
      from_yard: '',
      to_yard: '',
      route: '',
      start_date: '',
      due_date: '',
      memo: '',
      status: 'open'
    };

    currentLines = [];
    if (order && Array.isArray(order.lines) && order.lines.length) {
      order.lines.forEach(l => addLine(l));
    } else {
      addLine();
    }

    document.getElementById('dlgTitle').textContent = currentOrder.order_id ? '案件（編集）' : '案件（新規）';
    document.getElementById('dlgSub').textContent = currentOrder.order_id ? `order_id: ${currentOrder.order_id}` : '';

    document.getElementById('f_customer').value = currentOrder.customer || '';
    document.getElementById('f_order_no').value = currentOrder.order_no || '';
    document.getElementById('f_vessel').value = currentOrder.vessel || '';
    document.getElementById('f_bl_bk').value = currentOrder.bl_bk || '';

    // infer areas from yards (for edit stability)
    const fromArea = findAreaForYard(currentOrder.from_yard);
    document.getElementById('f_from_area').value = fromArea;
    updateYards(document.getElementById('f_from_area'), document.getElementById('f_from_yard'));
    document.getElementById('f_from_yard').value = currentOrder.from_yard || '';

    const toArea = findAreaForYard(currentOrder.to_yard);
    document.getElementById('f_to_area').value = toArea;
    updateYards(document.getElementById('f_to_area'), document.getElementById('f_to_yard'));
    document.getElementById('f_to_yard').value = currentOrder.to_yard || '';

    document.getElementById('f_route').value = currentOrder.route || '';
    document.getElementById('f_start_date').value = currentOrder.start_date || '';
    document.getElementById('f_due_date').value = currentOrder.due_date || '';
    document.getElementById('f_memo').value = currentOrder.memo || '';

    document.getElementById('f_qty_done_today').value = '';
    renderLines();

    document.getElementById('dlg').showModal();
  }

  function readDialogOrderAndLines() {
    const order = {
      order_id: currentOrder.order_id || '',
      customer: document.getElementById('f_customer').value,
      order_no: document.getElementById('f_order_no').value,
      vessel: document.getElementById('f_vessel').value,
      bl_bk: document.getElementById('f_bl_bk').value,

      from_yard: document.getElementById('f_from_yard').value,
      to_yard: document.getElementById('f_to_yard').value,

      route: document.getElementById('f_route').value,
      start_date: document.getElementById('f_start_date').value,
      due_date: document.getElementById('f_due_date').value,
      memo: document.getElementById('f_memo').value
    };

    const lines = currentLines.map(l => ({
      line_id: l.line_id || '',
      size: l.size || '',
      container_type: l.container_type || '',
      qty_total: Number(l.qty_total || 0),
      memo: l.memo || ''
    }));

    return { order, lines };
  }

  /************ Events ************/
  document.getElementById('btnReload').addEventListener('click', () => reload().catch(alert));
  document.getElementById('btnNew').addEventListener('click', () => openDialog(null));
  document.getElementById('btnClose').addEventListener('click', () => document.getElementById('dlg').close());

  document.getElementById('statusFilter').addEventListener('change', () => buildTimeline(allOrders));
  document.getElementById('routeFilterSel').addEventListener('change', () => buildTimeline(allOrders));
  document.getElementById('customerFilterSel').addEventListener('change', () => buildTimeline(allOrders));
  document.getElementById('includeOldDone').addEventListener('change', () => reload().catch(alert));

  document.getElementById('f_from_area').addEventListener('change', () => {
    updateYards(document.getElementById('f_from_area'), document.getElementById('f_from_yard'));
  });
  document.getElementById('f_to_area').addEventListener('change', () => {
    updateYards(document.getElementById('f_to_area'), document.getElementById('f_to_yard'));
  });

  document.getElementById('btnAddLine').addEventListener('click', () => {
    addLine();
    renderLines();
  });

  document.getElementById('btnSave').addEventListener('click', async () => {
    try {
      const { order, lines } = readDialogOrderAndLines();

      if (!order.customer) throw new Error('依頼主が未選択です');
      if (!order.from_yard) throw new Error('搬出ヤードが未選択です');
      if (!order.to_yard) throw new Error('搬入ヤードが未選択です');
      if (!order.due_date) throw new Error('期限日が未入力です');
      // 日付の前後チェック（開始日が未入力なら「期限日＝開始日」とみなす運用ならここは任意）
const sd = document.getElementById('f_start_date').value;
const dd = document.getElementById('f_due_date').value;

// 開始日が空なら、開始日=期限日として扱う
const startYmd = sd || dd;
const dueYmd = dd;

if (startYmd && dueYmd && startYmd > dueYmd) {
  throw new Error('開始日が期限日より後になっています。開始日／期限日を確認してください。');
}


      if (!lines.length) throw new Error('内訳がありません');
      for (const ln of lines) {
        if (!ln.size) throw new Error('内訳のサイズが未選択の行があります');
        if (!ln.container_type) throw new Error('内訳の種類が未選択の行があります');
        if (ln.qty_total < 0) throw new Error('内訳の総本数は0以上で入力してください');
      }
      const total = lines.reduce((a, b) => a + Number(b.qty_total || 0), 0);
      if (total <= 0) throw new Error('内訳の合計本数が0です');

      await api('upsertOrder', { order, lines });

      document.getElementById('dlg').close();
      await reload();
      alert('保存しました。');
    } catch (e) {
      alert(e.message);
    }
  });

  document.getElementById('btnAddDone').addEventListener('click', async () => {
    try {
      if (!currentOrder || !currentOrder.order_id) {
        alert('先に案件を保存してください（order_idが必要です）。');
        return;
      }
      const work_date = document.getElementById('f_work_date').value;
      const qty_done_today = Number(document.getElementById('f_qty_done_today').value || 0);
      const line_id = document.getElementById('f_done_line').value;

      if (!work_date) throw new Error('作業日が未入力です');
      if (!line_id) throw new Error('内訳行が未選択です（保存後に選べます）');
      if (qty_done_today <= 0) throw new Error('当日完了本数は1以上を入力してください');

      await api('addCompletion', {
        order_id: currentOrder.order_id,
        order_line_id: line_id,
        work_date,
        qty_done_today
      });

      document.getElementById('dlg').close();
      await reload();
      alert('当日完了を追加しました。');
    } catch (e) {
      alert(e.message);
    }
  });

  /************ Boot ************/
  initDefaults();
  (async () => {
    try {
      await loadMasters();
      await reload();
    } catch (err) {
      console.error(err);
      alert('初期ロードに失敗しました。\n' + (err && (err.stack || err.message) ? (err.stack || err.message) : String(err)));
    }
  })();
</script>
</body>
</html>
