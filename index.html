<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Position / Feeder Board</title>

  <link rel="stylesheet" href="https://unpkg.com/vis-timeline@latest/styles/vis-timeline-graph2d.min.css">
  <script src="https://unpkg.com/vis-timeline@latest/standalone/umd/vis-timeline-graph2d.min.js">
// ========================================
// æœ¬èˆ¹åã‚ªãƒ¼ãƒˆã‚³ãƒ³ãƒ—ãƒªãƒ¼ãƒˆ
// ========================================
let vesselList = [];

  
  input.setAttribute('autocomplete', 'off');
  input.addEventListener('input', function() {
    const value = this.value.toUpperCase();
    if (!value) { list.style.display='none'; return; }
    
    const filtered = vesselList.filter(v => v.toUpperCase().includes(value));
    if (!filtered.length) { list.style.display='none'; return; }
    
    list.innerHTML = '';
    filtered.forEach(vessel => {
      const item = document.createElement('div');
      item.style.cssText = 'padding:10px;cursor:pointer;';
      item.textContent = vessel;
      item.onmouseover = () => item.style.backgroundColor='#e0f2fe';
      item.onmouseout = () => item.style.backgroundColor='';
      item.onclick = () => { input.value=vessel; list.style.display='none'; };
      list.appendChild(item);
    });
    list.style.display='block';
  });
  
  document.addEventListener('click', (e) => {
    if (!input.contains(e.target) && !list.contains(e.target)) list.style.display='none';
  });
}

// ========================================
// BL/BKè‡ªå‹•å¤‰æ›
// ========================================
function setupBlBkFormat() {
  const input = document.getElementById('blBk');
  if (!input) return;
  
  input.addEventListener('blur', function() {
    let v = this.value;
    v = v.replace(/[ã-ã‚“ã‚¡-ãƒ¶ãƒ¼ä¸€-é¾ ã€…]/g, '');
    v = v.replace(/[ï¼¡-ï¼ºï½-ï½šï¼-ï¼™]/g, s => String.fromCharCode(s.charCodeAt(0)-0xFEE0));
    this.value = v.toUpperCase();
  });
}

// åˆæœŸåŒ–
});


</script>

  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", sans-serif; margin: 0; }
    header { padding: 12px 16px; border-bottom: 1px solid #ddd; display: flex; gap: 12px; align-items: center; background: linear-gradient(135deg, #86efac 0%, #4ade80 100%); color: black; }
    header .spacer { flex: 1; }
    #wrap { display: flex; height: calc(100vh - 50px); }
    #left {
      width: 280px;
      min-width: 220px;
      max-width: 520px;
      padding: 12px;
      overflow: auto;
      border-right: none;
      background: #e0f2fe;
    }

    #splitter{
      width: 6px;
      cursor: col-resize;
      background: #eee;
      border-left: 1px solid #ddd;
      border-right: 1px solid #ddd;
    }

    #timeline{
      flex: 1 1 auto;
      min-width: 0;
      height: 100%;
    }
    .row { margin-bottom: 10px; }
    label { display:block; font-size: 12px; color: #444; margin-bottom: 4px; }
    label .required { color: #d32f2f; margin-left: 4px; font-weight: 600; }
    input, select, textarea { width: 100%; padding: 8px; box-sizing: border-box; }
    button { padding: 8px 10px; }
    .doneItem { opacity: 0.35; }
    .vis-time-axis .vis-text.axisSat { color: #1976d2 !important; font-weight: 600; }
    .vis-time-axis .vis-text.axisSun { color: #d32f2f !important; font-weight: 700; }

    .muted { color: #666; font-size: 12px; }

    .urgentItem {
      background: #d32f2f !important;
      border-color: #b71c1c !important;
      color: #fff !important;
    }
    .urgentItem .vis-item-content {
      color: #fff !important;
    }

    dialog { 
      width: min(1100px, 96vw); 
      max-height: 90vh;
      border: 1px solid #ccc; 
      border-radius: 10px; 
      padding: 0; 
    }
    dialog header { border-bottom: 1px solid #eee; }
    dialog .content { 
      padding: 16px 20px; 
      overflow-y: auto; 
      max-height: calc(90vh - 120px);
    }
    dialog .footer { 
      padding: 12px 16px; 
      border-top: 1px solid #eee; 
      display:flex; 
      justify-content:flex-end; 
      gap: 8px; 
    }

    /* ãƒ€ã‚¤ã‚¢ãƒ­ã‚°å†…ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
    .dialog-section {
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 16px;
      background: #fafafa;
    }
    .dialog-section-title {
      font-weight: 600;
      font-size: 14px;
      color: #333;
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 2px solid #1976d2;
    }
    
    /* ã‚°ãƒªãƒƒãƒ‰ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
    .form-grid-2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    .form-grid-3 {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 12px;
    }
    .form-grid-4 {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr 1fr;
      gap: 12px;
    }

    table { width: 100%; border-collapse: collapse; font-size: 12px; }
    th, td { border-bottom: 1px solid #eee; padding: 6px 4px; text-align: left; vertical-align: middle; }
    .mini { padding: 6px; }
    .btnSmall { padding: 6px 8px; font-size: 12px; }
    
    /* å®Œäº†æ•°è¡¨ç¤º */
    .done-badge {
      margin-left: 8px;
      color: #4caf50;
      font-size: 11px;
      font-weight: 600;
    }
  </style>
</head>

<body>
<header>
  <h1 style="font-size: 28px; font-weight: bold; margin: 0; letter-spacing: 1px;">ãƒã‚¸ã‚·ãƒ§ãƒ³ï¼ãƒ•ã‚£ãƒ¼ãƒ€ãƒ¼ ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ç®¡ç†</h1>
  <!-- è‡ªå‹•èª­è¾¼ãŒã‚ã‚‹ãŸã‚å‰Šé™¤ -->
  <button id="btnNew">æ–°è¦æ¡ˆä»¶</button>
  <label style="margin-left:12px; display:flex; align-items:center; gap:6px; cursor:pointer;">
    <input type="checkbox" id="autoReloadToggle" style="cursor:pointer;">
    <span style="font-size:13px;">è‡ªå‹•æ›´æ–°</span>
    <select id="autoReloadInterval" style="font-size:13px; padding:2px 4px; cursor:pointer;">
      <option value="30">30ç§’</option>
      <option value="60" selected>60ç§’</option>
      <option value="120">2åˆ†</option>
      <option value="300">5åˆ†</option>
    </select>
  </label>
  <div class="spacer"></div>
  <span class="muted" id="countdown" style="font-size:12px; margin-right:8px;"></span>
  <span class="muted" id="lastUpdate" style="font-size:12px; margin-right:8px;"></span>
  <span class="muted" id="statusText"></span>
</header>

<div id="wrap">
  <div id="left">
    <div class="row">
      <label>è¡¨ç¤ºé–‹å§‹</label>
      <input id="startDate" type="date" />
    </div>
    <div class="row">
      <label>è¡¨ç¤ºçµ‚äº†</label>
      <input id="endDate" type="date" />
    </div>

    <div class="row">
      <label>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</label>
      <select id="statusFilter">
        <option value="">ã™ã¹ã¦</option>
        <option value="open">æœªå®Œäº†</option>
        <option value="done">å®Œäº†</option>
      </select>
    </div>

    <div class="row">
      <label>ãƒ«ãƒ¼ãƒˆ</label>
      <select id="routeFilterSel"></select>
    </div>

    <div class="row">
      <label>ä¾é ¼ä¸»</label>
      <select id="customerFilterSel"></select>
    </div>

    <div class="row">
      <label>
        <input type="checkbox" id="includeOldDone">
        å®Œäº†ï¼ˆ3ã‹æœˆè¶…ï¼‰ã‚‚è¡¨ç¤º
      </label>
    </div>
  </div>
  <div id="splitter" title="ãƒ‰ãƒ©ãƒƒã‚°ã§å¹…èª¿æ•´"></div>
  <div id="timeline"></div>
</div>

<dialog id="dlg">
  <header>
    <div style="padding:12px 16px; display:flex; align-items:center; gap:12px;">
      <strong id="dlgTitle">æ¡ˆä»¶</strong>
      <span class="muted" id="dlgSub"></span>
      <div class="spacer"></div>
      <button id="btnClose" type="button">é–‰ã˜ã‚‹</button>
    </div>
  </header>

  <div class="content">
    <!-- åŸºæœ¬æƒ…å ± -->
    <div class="dialog-section">
      <div class="dialog-section-title">ğŸ“‹ åŸºæœ¬æƒ…å ±</div>
      <div class="form-grid-2">
        <div class="row">
          <label>ä¾é ¼ä¸»<span class="required">*</span></label>
          <select id="f_customer"></select>
        </div>
        <div class="row">
          <label>å—æ³¨ç•ªå·<span class="required">*</span></label>
          <input id="f_order_no" placeholder="åŠè§’è‹±æ•°å­—ï¼ˆè‡ªå‹•å¤‰æ›ï¼‰">
        </div>
      </div>
      
      <div class="form-grid-3">
        <div class="row">
          <label>æœ¬èˆ¹å</label>
          <input id="f_vessel" placeholder="æœ¬èˆ¹åã‚’å…¥åŠ›ï¼ˆå€™è£œã‹ã‚‰é¸æŠå¯ï¼‰">
        </div>
        <div class="row">
          <label>BL/BKï¼ˆå…¥åŠ›å¾Œè‡ªå‹•å¤‰æ›ï¼‰</label>
          <input id="f_bl_bk" placeholder="åŠè§’è‹±æ•°å­—ï¼ˆè‡ªå‹•å¤‰æ›ï¼‰">
        </div>
        <div class="row">
          <label>VOY No</label>
          <input id="f_voy" placeholder="åŠè§’è‹±æ•°å­—ï¼ˆè‡ªå‹•å¤‰æ›ï¼‰">
        </div>
      </div>
    </div>

    <!-- è¼¸é€æƒ…å ± -->
    <div class="dialog-section">
      <div class="dialog-section-title">ğŸšš è¼¸é€æƒ…å ±</div>
      <div class="form-grid-4">
        <div class="row">
          <label>é…é€å…ˆ<span style="color:red;">*</span></label>
          <select id="f_destination"></select>
        </div>
        <div class="row">
          <label>ã‚·ãƒ£ãƒ¼ã‚·</label>
          <select id="f_chassis"></select>
        </div>
        <div class="row">
          <label>ç¨åŒºåˆ†</label>
          <select id="f_tax"></select>
        </div>
        <div class="row">
          <label>è¼¸å…¥å‡º</label>
          <select id="f_inout"></select>
        </div>
      </div>
    </div>

    <!-- ãƒ¤ãƒ¼ãƒ‰æƒ…å ± -->
    <div class="dialog-section">
      <div class="dialog-section-title">ğŸ“ ãƒ¤ãƒ¼ãƒ‰æƒ…å ±</div>
      <div class="form-grid-2">
        <div>
          <div class="row">
            <label>æ¬å‡º åœ°åŸŸ<span class="required">*</span></label>
            <select id="f_from_area"></select>
          </div>
          <div class="row">
            <label>æ¬å‡º ãƒ¤ãƒ¼ãƒ‰<span class="required">*</span></label>
            <select id="f_from_yard"></select>
          </div>
        </div>
        <div>
          <div class="row">
            <label>æ¬å…¥ åœ°åŸŸ<span class="required">*</span></label>
            <select id="f_to_area"></select>
          </div>
          <div class="row">
            <label>æ¬å…¥ ãƒ¤ãƒ¼ãƒ‰<span class="required">*</span></label>
            <select id="f_to_yard"></select>
          </div>
        </div>
      </div>
      <div class="row">
        <label>ãƒ«ãƒ¼ãƒˆï¼ˆç©ºãªã‚‰è‡ªå‹•ç”Ÿæˆï¼‰</label>
        <input id="f_route" placeholder="ä¾‹ï¼šé’æµ·A-1â†’å—æœ¬ç‰§">
      </div>
    </div>

    <!-- æ—¥ç¨‹æƒ…å ± -->
    <div class="dialog-section">
      <div class="dialog-section-title">ğŸ“… æ—¥ç¨‹æƒ…å ±</div>
      <div class="form-grid-3">
        <div class="row">
          <label>é–‹å§‹æ—¥ï¼ˆè¡¨ç¤ºç”¨ï¼‰</label>
          <input id="f_start_date" type="date">
        </div>
        <div class="row">
          <label>æœŸé™æ—¥<span class="required">*</span></label>
          <input id="f_due_date" type="date">
        </div>
        <div class="row">
          <label>ãƒ¡ãƒ¢</label>
          <input id="f_memo">
        </div>
      </div>
    </div>

    <!-- å†…è¨³ -->
    <div class="dialog-section">
      <div class="dialog-section-title">ğŸ“¦ å†…è¨³ï¼ˆã‚µã‚¤ã‚ºÃ—ç¨®é¡Ã—æœ¬æ•°ï¼‰</div>
      <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:12px;">
        <div class="muted">åŒä¸€æ¡ˆä»¶å†…ã«è¤‡æ•°è¡Œã§ç™»éŒ²ã§ãã¾ã™ï¼ˆãƒãƒ¼ã¯å¢—ãˆã¾ã›ã‚“ï¼‰</div>
        <button class="btnSmall" id="btnAddLine" type="button">+ å†…è¨³è¡Œã‚’è¿½åŠ </button>
      </div>

      <div style="overflow:auto;">
        <table>
          <thead>
            <tr>
              <th style="width:100px;">ã‚µã‚¤ã‚º</th>
              <th style="width:160px;">ç¨®é¡</th>
              <th style="width:80px;">ç·æœ¬æ•°</th>
              <th style="width:100px;">æ–™é‡‘</th>
              <th>ãƒ¡ãƒ¢</th>
              <th style="width:60px;"></th>
            </tr>
          </thead>
          <tbody id="linesBody"></tbody>
        </table>
      </div>

      <div class="muted" id="linesTotalText" style="margin-top:8px;">åˆè¨ˆ: -</div>
    </div>
  </div>

  <div class="footer">
    <button id="btnSave" type="button">ğŸ’¾ ä¿å­˜</button>
  </div>
</dialog>

<script>
  /************ è¨­å®šï¼ˆã“ã“ã ã‘å·®ã—æ›¿ãˆï¼‰ ************/
  const GAS_URL = 'https://script.google.com/macros/s/AKfycbx5HV_menEoAEihgvJDfAkwePogYodNlNY8Okgxd2rbvBvmBID18dm_2N8fqXhknOI43A/exec';
  const TOKEN  = 'pf_2026_01_16';

  /************ çŠ¶æ…‹ ************/
  let timeline;
  let allOrders = [];
  let masters = null;

  let currentOrder = null;
  let currentLines = [];

  const JP_DOW = ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'];
  let holidaySet = new Set();

  // è‡ªå‹•æ›´æ–°ç”¨
  let autoReloadInterval = null;
  let countdownInterval = null;
  let nextReloadTime = null;

  function toJsDate(x) {
    if (x instanceof Date) return x;
    const d = new Date(x);
    if (isNaN(d.getTime())) return null;
    return d;
  }

  function ymdFromDate(x) {
    const d = toJsDate(x);
    if (!d) return '';
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth() + 1).padStart(2, '0');
    const dd = String(d.getDate()).padStart(2, '0');
    return `${yyyy}-${mm}-${dd}`;
  }

  let axisClassByLabelText = Object.create(null);

  function axisDayLabel(x) {
    const date = toJsDate(x);
    if (!date) return '';

    const d = date.getDate();
    const dow = JP_DOW[date.getDay()];
    const ymd = ymdFromDate(date);

    const isHoliday = holidaySet.has(ymd);
    const isSun = (date.getDay() === 0) || isHoliday;
    const isSat = (date.getDay() === 6);

    const text = `${d}æ—¥(${dow})`;
    axisClassByLabelText[text] = isSun ? 'axisSun' : (isSat ? 'axisSat' : '');
    return text;
  }

  function applyAxisColors() {
    const labels = document.querySelectorAll('#timeline .vis-time-axis .vis-text.vis-minor');
    labels.forEach(el => {
      el.classList.remove('axisSat', 'axisSun');
      const t = (el.textContent || '').trim();
      const cls = axisClassByLabelText[t];
      if (cls) el.classList.add(cls);
    });
  }

  /************ Utils ************/
  function toDate(d) {
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth()+1).padStart(2,'0');
    const dd = String(d.getDate()).padStart(2,'0');
    return `${yyyy}-${mm}-${dd}`;
  }
  
  function normalizeYmd(v) {
    if (!v) return '';
    if (v instanceof Date) return toDate(v);
    const s = String(v).trim();
    if (!s) return '';
    if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;
    const d = new Date(s);
    if (!isNaN(d.getTime())) return toDate(d);
    return '';
  }

  function fmtSizeLabel(v) {
    const s = String(v ?? '').trim();
    if (!s) return '';
    return (/^\d+$/.test(s)) ? `${s}F` : s;
  }

  // åŠè§’å¤§æ–‡å­—è‹±æ•°å­—ã¸ã®å¤‰æ›é–¢æ•°
  function normalizeAlphanumeric(str) {
    if (!str) return '';
    let s = String(str);
    
    // å…¨è§’â†’åŠè§’
    s = s.replace(/[ï¼-ï¼™ï¼¡-ï¼ºï½-ï½š]/g, ch =>
      String.fromCharCode(ch.charCodeAt(0) - 0xFEE0)
    );
    
    // å¤§æ–‡å­—åŒ–
    s = s.toUpperCase();
    
    // è‹±æ•°å­—ã¨ãƒã‚¤ãƒ•ãƒ³ã®ã¿æ®‹ã™
    s = s.replace(/[^A-Z0-9\-]/g, '');
    
    return s;
  }

  function addDays(anyDateLike, days) {
    const ymd = normalizeYmd(anyDateLike);
    if (!ymd) return '';
    const d = new Date(ymd + 'T00:00:00');
    d.setDate(d.getDate() + days);
    return toDate(d);
  }

  function jsonp(url) {
    return new Promise((resolve, reject) => {
      const cb = 'cb_' + Math.random().toString(36).slice(2);
      url.searchParams.set('callback', cb);

      const script = document.createElement('script');
      script.src = url.toString();

      window[cb] = (data) => { cleanup(); resolve(data); };
      script.onerror = () => { cleanup(); reject(new Error('jsonp_load_failed')); };

      function cleanup() {
        try { delete window[cb]; } catch (_) {}
        script.remove();
      }
      document.head.appendChild(script);
    });
  }

  async function api(action, payloadObj) {
    const url = new URL(GAS_URL);
    url.searchParams.set('token', TOKEN);
    url.searchParams.set('action', action);
    if (payloadObj) url.searchParams.set('payload', JSON.stringify(payloadObj));

    const resp = await jsonp(url);
    if (!resp.ok) throw new Error(resp.error || 'api_error');
    return resp.data;
  }

  function setOptions(selectEl, options, placeholder) {
    selectEl.innerHTML = '';
    const opt0 = document.createElement('option');
    opt0.value = '';
    opt0.textContent = placeholder || 'ã™ã¹ã¦';
    selectEl.appendChild(opt0);

    for (const v of options) {
      const opt = document.createElement('option');
      opt.value = v;
      opt.textContent = v;
      selectEl.appendChild(opt);
    }
  }

  function uniqueStable(arr) {
    const seen = new Set();
    const out = [];
    for (const v of arr) {
      const s = String(v || '').trim();
      if (!s || seen.has(s)) continue;
      seen.add(s);
      out.push(s);
    }
    return out;
  }

  function refreshLeftFilters(orders) {
    const routes = uniqueStable(orders.map(o => o.route || '(æœªè¨­å®š)'));
    setOptions(document.getElementById('routeFilterSel'), routes, 'ã™ã¹ã¦');
    setOptions(document.getElementById('customerFilterSel'), (masters?.customers || []), 'ã™ã¹ã¦');
  }

  function findAreaForYard(yard) {
    const y = String(yard || '').trim();
    if (!y) return '';
    const m = masters?.yardsByArea || {};
    for (const area of Object.keys(m)) {
      if ((m[area] || []).includes(y)) return area;
    }
    return '';
  }

  /************ Load ************/
  function initDefaults() {
    const today = new Date();
    const start = new Date(today); start.setDate(today.getDate()-7);
    const end   = new Date(today); end.setDate(today.getDate()+21);

    document.getElementById('startDate').value = toDate(start);
    document.getElementById('endDate').value   = toDate(end);
  }

  async function loadMasters() {
    masters = await api('listMasters');
    holidaySet = new Set(masters?.holidays || []);

    setOptions(document.getElementById('f_customer'), masters.customers || [], 'é¸æŠã—ã¦ãã ã•ã„');
    setOptions(document.getElementById('f_from_area'), masters.yardAreas || [], 'åœ°åŸŸã‚’é¸æŠ');
    setOptions(document.getElementById('f_to_area'), masters.yardAreas || [], 'åœ°åŸŸã‚’é¸æŠ');
    setOptions(document.getElementById('f_from_yard'), [], 'ãƒ¤ãƒ¼ãƒ‰ã‚’é¸æŠ');
    setOptions(document.getElementById('f_to_yard'), [], 'ãƒ¤ãƒ¼ãƒ‰ã‚’é¸æŠ');

    setOptions(document.getElementById('f_inout'),   ['è¼¸å…¥','è¼¸å‡º'], 'é¸æŠã—ã¦ãã ã•ã„');
    setOptions(document.getElementById('f_chassis'), ['3è»¸','MG'],     'é¸æŠã—ã¦ãã ã•ã„');
    setOptions(document.getElementById('f_tax'),     ['èª²ç¨','å…ç¨'],  'é¸æŠã—ã¦ãã ã•ã„');
    setOptions(document.getElementById('f_destination'), masters.destinations || [], 'é¸æŠã—ã¦ãã ã•ã„');
  }

  async function loadOrders() {
    const start = document.getElementById('startDate').value;
    const end   = document.getElementById('endDate').value;
    const includeOldDone = document.getElementById('includeOldDone').checked;

    const url = new URL(GAS_URL);
    url.searchParams.set('token', TOKEN);
    url.searchParams.set('action', 'listOrders');
    url.searchParams.set('start_date', start);
    url.searchParams.set('end_date', end);
    url.searchParams.set('include_old_done', includeOldDone ? '1' : '0');

    const resp = await jsonp(url);
    if (!resp.ok) throw new Error(resp.error || 'listOrders_failed');
    return resp.data || [];
  }

  /************ Timeline ************/
  function buildTimeline(orders) {
    const statusFilter = document.getElementById('statusFilter').value;
    const routeFilter = document.getElementById('routeFilterSel').value;
    const customerFilter = document.getElementById('customerFilterSel').value;

    const filtered = orders.filter(o => {
      if (statusFilter && String(o.status) !== statusFilter) return false;
      if (routeFilter && String(o.route || '') !== routeFilter) return false;
      if (customerFilter && String(o.customer || '') !== customerFilter) return false;
      return true;
    });

    const customerMaster = (masters?.customers || []).map(x => String(x).trim()).filter(Boolean);
    const customerFromData = uniqueStable(filtered.map(o => String(o.customer || '(æœªè¨­å®š)').trim() || '(æœªè¨­å®š)'));

    const customers = [
      ...customerMaster.filter(c => customerFromData.includes(c)),
      ...customerFromData.filter(c => !customerMaster.includes(c))
    ];

    const groupArr = customers.map(c => ({ id: c, content: c }));
    const groups = new vis.DataSet(groupArr);

    const itemArr = filtered.map(o => {
      const start = normalizeYmd(o.start_date || o.due_date);
      const due   = normalizeYmd(o.due_date || start);

      if (!start || !due) return null;

      const endExclusive = addDays(due, 1);

      const done = Number(o.qty_done || 0);
      const total = Number(o.qty_total || 0);
      const remaining = Number(
        (o.qty_remaining != null && o.qty_remaining !== '') ? o.qty_remaining : Math.max(total - done, 0)
      );

      const today = new Date();
      today.setHours(0,0,0,0);

      const dueDate = new Date(due + 'T00:00:00');
      dueDate.setHours(0,0,0,0);

      const daysLeft = Math.floor((dueDate - today) / (24 * 60 * 60 * 1000));
      const isUrgent = (remaining > 0 && daysLeft <= 1);

      const lines = (o.lines || []).map(l => {
        const key = `${l.size}/${l.container_type}`;
        const lDone = Number(l.qty_done || 0);
        const lTotal = Number(l.qty_total || 0);
        const lRem = Number(
          (l.qty_remaining != null && l.qty_remaining !== '') ? l.qty_remaining : Math.max(lTotal - lDone, 0)
        );
        return `${key}: ${lDone}/${lTotal}ï¼ˆæ®‹${lRem}ï¼‰`;
      }).join('\n');

      const bySize = {};
      (o.lines || []).forEach(l => {
        const sizeKey = fmtSizeLabel(l.size);
        if (!sizeKey) return;
        const rem = Number(
          l.qty_remaining != null
            ? l.qty_remaining
            : Math.max(Number(l.qty_total || 0) - Number(l.qty_done || 0), 0)
        );
        bySize[sizeKey] = (bySize[sizeKey] || 0) + rem;
      });

      const sizeRemText = Object.keys(bySize).length
        ? Object.entries(bySize).map(([k,v]) => `${k}æ®‹${v}`).join('<br>')
        : `æ®‹${remaining}`;

      const routeText = String(o.route || '').trim() || [o.from_yard, o.to_yard].filter(Boolean).join('â†’') || '(ãƒ«ãƒ¼ãƒˆæœªè¨­å®š)';
      const orderNoText = String(o.order_no || '').trim();

      const content = `${routeText}<br>${orderNoText}<br>${sizeRemText}`;

      const cls = [];
      if (String(o.status) === 'done') cls.push('doneItem');
      if (isUrgent) cls.push('urgentItem');

      return {
        id: o.order_id,
        group: String(o.customer || '(æœªè¨­å®š)').trim() || '(æœªè¨­å®š)',
        start,
        end: endExclusive,
        content,
        title: lines,
        className: cls.join(' ')
      };
    }).filter(Boolean);

    const items = new vis.DataSet(itemArr);
    const container = document.getElementById('timeline');

    const startInput = document.getElementById('startDate').value;
    const endInput   = document.getElementById('endDate').value;

    const dayMs = 24 * 60 * 60 * 1000;
    const winStartBase = new Date(startInput + 'T00:00:00');
    const winEndBase   = new Date(endInput + 'T00:00:00');
    const winEndBaseExclusive = new Date(winEndBase.getTime() + dayMs);

    const center = new Date((winStartBase.getTime() + winEndBaseExclusive.getTime()) / 2);
    const DAYS_ON_SCREEN = 15;
    const half = Math.floor(DAYS_ON_SCREEN / 2);

    const windowStart = new Date(center.getTime() - half * dayMs);
    const windowEnd   = new Date(center.getTime() + (DAYS_ON_SCREEN - half) * dayMs);

    const options = {
      stack: true,
      timeAxis: { scale: 'day', step: 1 },
      format: {
        minorLabels: { day: 'MM/DDï¼ˆdddï¼‰' },
        majorLabels: { day: 'YYYYå¹´Mæœˆ' }
      },
      zoomable: false,
      moveable: true,
      start: windowStart,
      end: windowEnd
    };

    if (timeline) timeline.destroy();

    axisClassByLabelText = Object.create(null);
    timeline = new vis.Timeline(container, items, groups, options);

    timeline.setOptions({
      locale: 'ja',
      timeAxis: { scale: 'day', step: 1 },
      format: {
        minorLabels: function(x, scale, step) {
          if (scale !== 'day') return '';
          return axisDayLabel(x);
        },
        majorLabels: function(x, scale, step) {
          if (scale !== 'day') return '';
          const d = toJsDate(x);
          if (!d) return '';
          return `${d.getFullYear()}å¹´${d.getMonth()+1}æœˆ`;
        }
      }
    });

    timeline.on('changed', applyAxisColors);
    setTimeout(applyAxisColors, 0);

    timeline.on('select', props => {
      if (!props.items || props.items.length === 0) return;
      const id = props.items[0];
      const o = filtered.find(x => String(x.order_id) === String(id));
      if (o) openDialog(o);
    });

    document.getElementById('statusText').textContent =
      `è¡¨ç¤º ${filtered.length}ä»¶ / èª­è¾¼ ${orders.length}ä»¶`;
  }

  async function reload() {
    document.getElementById('statusText').textContent = 'èª­è¾¼ä¸­...';
    allOrders = await loadOrders();
    refreshLeftFilters(allOrders);
    buildTimeline(allOrders);
    
    // æœ€çµ‚æ›´æ–°æ™‚åˆ»ã‚’è¡¨ç¤º
    const now = new Date();
    const hh = String(now.getHours()).padStart(2, '0');
    const mm = String(now.getMinutes()).padStart(2, '0');
    const ss = String(now.getSeconds()).padStart(2, '0');
    document.getElementById('lastUpdate').textContent = `æœ€çµ‚æ›´æ–°: ${hh}:${mm}:${ss}`;
  }

  // ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³è¡¨ç¤ºã‚’æ›´æ–°
  function updateCountdown() {
    if (!nextReloadTime) {
      document.getElementById('countdown').textContent = '';
      return;
    }
    
    const now = Date.now();
    const remaining = Math.max(0, Math.ceil((nextReloadTime - now) / 1000));
    
    if (remaining > 0) {
      document.getElementById('countdown').textContent = `æ¬¡å›æ›´æ–°: ${remaining}ç§’å¾Œ`;
    } else {
      document.getElementById('countdown').textContent = 'æ›´æ–°ä¸­...';
    }
  }

  // è‡ªå‹•æ›´æ–°ã®é–‹å§‹
  function startAutoReload() {
    stopAutoReload(); // æ—¢å­˜ã®ã‚¿ã‚¤ãƒãƒ¼ã‚’ã‚¯ãƒªã‚¢
    
    const seconds = Number(document.getElementById('autoReloadInterval').value);
    nextReloadTime = Date.now() + (seconds * 1000);
    
    // ãƒ¡ã‚¤ãƒ³ã®æ›´æ–°ã‚¿ã‚¤ãƒãƒ¼
    autoReloadInterval = setInterval(async () => {
      try {
        console.log('[è‡ªå‹•æ›´æ–°] å®Ÿè¡Œä¸­...');
        await reload();
        console.log('[è‡ªå‹•æ›´æ–°] å®Œäº†');
        nextReloadTime = Date.now() + (seconds * 1000); // æ¬¡å›æ›´æ–°æ™‚åˆ»ã‚’ãƒªã‚»ãƒƒãƒˆ
      } catch (e) {
        console.error('[è‡ªå‹•æ›´æ–°] ã‚¨ãƒ©ãƒ¼:', e);
      }
    }, seconds * 1000);
    
    // ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³è¡¨ç¤ºã‚¿ã‚¤ãƒãƒ¼ï¼ˆ1ç§’ã”ã¨ï¼‰
    countdownInterval = setInterval(updateCountdown, 1000);
    updateCountdown(); // å³åº§ã«è¡¨ç¤º
    
    console.log(`[è‡ªå‹•æ›´æ–°] é–‹å§‹ï¼ˆ${seconds}ç§’é–“éš”ï¼‰`);
  }

  // è‡ªå‹•æ›´æ–°ã®åœæ­¢
  function stopAutoReload() {
    if (autoReloadInterval) {
      clearInterval(autoReloadInterval);
      autoReloadInterval = null;
    }
    if (countdownInterval) {
      clearInterval(countdownInterval);
      countdownInterval = null;
    }
    nextReloadTime = null;
    document.getElementById('countdown').textContent = '';
    console.log('[è‡ªå‹•æ›´æ–°] åœæ­¢');
  }

  /************ Dependent yard dropdown ************/
  function updateYards(selectAreaEl, selectYardEl) {
    const area = selectAreaEl.value;
    const list = (masters && masters.yardsByArea && masters.yardsByArea[area]) ? masters.yardsByArea[area] : [];
    setOptions(selectYardEl, list, 'ãƒ¤ãƒ¼ãƒ‰ã‚’é¸æŠ');
  }

  /************ Lines UI ************/
  function renderLines() {
    const body = document.getElementById('linesBody');
    body.innerHTML = '';

    const sizes = (masters && masters.sizes) ? masters.sizes : [];
    const ctypes = (masters && masters.containerTypes) ? masters.containerTypes : [];

    currentLines.forEach((ln, idx) => {
      const tr = document.createElement('tr');

      const tdSize = document.createElement('td');
      const selSize = document.createElement('select');
      selSize.className = 'mini';
      setOptions(selSize, sizes, 'é¸æŠ');
      selSize.value = ln.size || '';
      selSize.onchange = () => { 
        ln.size = selSize.value;
        // ã‚µã‚¤ã‚ºã¨ç¨®é¡ã®ä¸¡æ–¹ãŒé¸æŠã•ã‚Œã¦ã„ã‚Œã°æ–™é‡‘å–å¾—
        if (ln.size && ln.container_type) {
          autoFillRate(ln);
        }
        updateLinesTotalAndDoneSelect(); 
      };
      tdSize.appendChild(selSize);

      const tdType = document.createElement('td');
      const selType = document.createElement('select');
      selType.className = 'mini';
      setOptions(selType, ctypes, 'é¸æŠ');
      selType.value = ln.container_type || '';
      selType.onchange = () => { 
        ln.container_type = selType.value;
        // ã‚µã‚¤ã‚ºã¨ç¨®é¡ã®ä¸¡æ–¹ãŒé¸æŠã•ã‚Œã¦ã„ã‚Œã°æ–™é‡‘å–å¾—
        if (ln.size && ln.container_type) {
          autoFillRate(ln);
        }
        updateLinesTotalAndDoneSelect(); 
      };
      tdType.appendChild(selType);

      const tdQty = document.createElement('td');
      const inpQty = document.createElement('input');
      inpQty.type = 'number';
      inpQty.min = '0';
      inpQty.className = 'mini';
      inpQty.value = (ln.qty_total ?? 0);
      
      // å®Œäº†æ•°ã‚’å–å¾—
      const doneQty = Number(ln.qty_done || 0);
      
      // å®Œäº†æ•°ä»¥ä¸Šã‚’æœ€å°å€¤ã«è¨­å®š
      if (doneQty > 0) {
        inpQty.min = String(doneQty);
        inpQty.title = `å®Œäº†æ¸ˆã¿${doneQty}æœ¬ãŒã‚ã‚‹ãŸã‚ã€${doneQty}æœ¬æœªæº€ã«ã¯è¨­å®šã§ãã¾ã›ã‚“`;
      }
      
      inpQty.oninput = () => { 
        const newVal = Number(inpQty.value || 0);
        
        // å®Œäº†æ•°ãƒã‚§ãƒƒã‚¯
        if (doneQty > 0 && newVal < doneQty) {
          alert(`ã“ã®å†…è¨³ã¯æ—¢ã«${doneQty}æœ¬å®Œäº†ã—ã¦ã„ã¾ã™ã€‚${doneQty}æœ¬æœªæº€ã«ã¯è¨­å®šã§ãã¾ã›ã‚“ã€‚`);
          inpQty.value = doneQty;
          ln.qty_total = doneQty;
        } else {
          ln.qty_total = newVal;
        }
        
        updateLinesTotalAndDoneSelect(); 
      };
      tdQty.appendChild(inpQty);
      
      // å®Œäº†æ•°ã®è¡¨ç¤º
      if (doneQty > 0) {
        const doneLabel = document.createElement('span');
        doneLabel.className = 'done-badge';
        doneLabel.textContent = `(å®Œäº†${doneQty})`;
        tdQty.appendChild(doneLabel);
      }

      // æ–™é‡‘å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
      const tdRate = document.createElement('td');
      const inpRate = document.createElement('input');
      inpRate.type = 'text';
      inpRate.className = 'mini';
      inpRate.value = ln.rate || '';
      inpRate.placeholder = 'ãƒã‚¹ã‚¿å–å¾—';
      inpRate.oninput = () => { ln.rate = inpRate.value; };
      tdRate.appendChild(inpRate);

      const tdMemo = document.createElement('td');
      const inpMemo = document.createElement('input');
      inpMemo.className = 'mini';
      inpMemo.value = ln.memo || '';
      inpMemo.oninput = () => { ln.memo = inpMemo.value; };
      tdMemo.appendChild(inpMemo);

      const tdRm = document.createElement('td');
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'btnSmall';
      btn.textContent = 'å‰Šé™¤';
      
      // å®Œäº†æ•°ãŒã‚ã‚‹å ´åˆã¯å‰Šé™¤ä¸å¯
      if (doneQty > 0) {
        btn.disabled = true;
        btn.title = `å®Œäº†æ¸ˆã¿${doneQty}æœ¬ãŒã‚ã‚‹ãŸã‚å‰Šé™¤ã§ãã¾ã›ã‚“`;
        btn.style.opacity = '0.5';
        btn.style.cursor = 'not-allowed';
      } else {
        btn.onclick = () => {
          currentLines.splice(idx, 1);
          if (currentLines.length === 0) addLine();
          renderLines();
        };
      }
      
      tdRm.appendChild(btn);

      tr.appendChild(tdSize);
      tr.appendChild(tdType);
      tr.appendChild(tdQty);
      tr.appendChild(tdRate);
      tr.appendChild(tdMemo);
      tr.appendChild(tdRm);

      body.appendChild(tr);
    });

    updateLinesTotalAndDoneSelect();
  }

  // æ–™é‡‘è‡ªå‹•å–å¾—
  async function autoFillRate(line) {
    // ç”»é¢ã‹ã‚‰ç›´æ¥å–å¾—
    const customerShort = document.getElementById('f_customer').value;
    const destination = document.getElementById('f_destination').value;
    
    console.log('[æ–™é‡‘å–å¾—] é–‹å§‹', {
      customer: customerShort,
      destination: destination,
      size: line.size,
      container_type: line.container_type
    });
    
    if (!customerShort || !destination) {
      console.log('[æ–™é‡‘å–å¾—] ã‚¹ã‚­ãƒƒãƒ—: å¾—æ„å…ˆã¾ãŸã¯é…é€å…ˆãŒæœªé¸æŠ');
      return;
    }
    if (!line.size || !line.container_type) {
      console.log('[æ–™é‡‘å–å¾—] ã‚¹ã‚­ãƒƒãƒ—: ã‚µã‚¤ã‚ºã¾ãŸã¯ç¨®é¡ãŒæœªé¸æŠ');
      return;
    }
    
    try {
      console.log('[æ–™é‡‘å–å¾—] APIå‘¼ã³å‡ºã—ä¸­...');
      const rate = await api('getRate', {
        customer: customerShort,
        destination: destination,
        size: line.size,
        container_type: line.container_type
      });
      
      console.log('[æ–™é‡‘å–å¾—] APIå¿œç­”:', rate);
      
      if (rate) {
        line.rate = rate;
        console.log('[æ–™é‡‘å–å¾—] æ–™é‡‘è¨­å®šå®Œäº†:', rate);
        renderLines();
      } else {
        console.log('[æ–™é‡‘å–å¾—] æ–™é‡‘ãƒã‚¹ã‚¿ã«è©²å½“ãªã—');
      }
    } catch (e) {
      console.error('[æ–™é‡‘å–å¾—] ã‚¨ãƒ©ãƒ¼:', e);
      console.error('[æ–™é‡‘å–å¾—] ã‚¨ãƒ©ãƒ¼è©³ç´°:', {
        message: e.message,
        stack: e.stack
      });
      // ã‚¨ãƒ©ãƒ¼ã§ã‚‚å‡¦ç†ã¯ç¶™ç¶šï¼ˆæ‰‹å‹•å…¥åŠ›å¯èƒ½ï¼‰
    }
  }

  function addLine(defaults) {
    currentLines.push({
      line_id: (defaults && defaults.line_id) ? defaults.line_id : '',
      size: (defaults && defaults.size) ? defaults.size : '',
      container_type: (defaults && defaults.container_type) ? defaults.container_type : '',
      qty_total: (defaults && defaults.qty_total != null) ? Number(defaults.qty_total) : 0,
      memo: (defaults && defaults.memo) ? defaults.memo : '',
      qty_done: (defaults && defaults.qty_done != null) ? Number(defaults.qty_done) : 0,
      qty_remaining: (defaults && defaults.qty_remaining != null) ? Number(defaults.qty_remaining) : 0,
      rate: (defaults && defaults.rate) ? defaults.rate : ''
    });
  }

  function updateLinesTotalAndDoneSelect() {
    const total = currentLines.reduce((a, b) => a + Number(b.qty_total || 0), 0);
    document.getElementById('linesTotalText').textContent = `åˆè¨ˆ: ${total} æœ¬`;
  }

  /************ Dialog ************/
  function openDialog(order) {
    currentOrder = order ? { ...order } : {
      order_id: '',
      customer: '',
      order_no: '',
      vessel: '',
      bl_bk: '',
      from_yard: '',
      to_yard: '',
      route: '',
      start_date: '',
      due_date: '',
      memo: '',
      status: 'open'
    };

    currentLines = [];
    if (order && Array.isArray(order.lines) && order.lines.length) {
      order.lines.forEach(l => addLine(l));
    } else {
      addLine();
    }

    document.getElementById('dlgTitle').textContent = currentOrder.order_id ? 'æ¡ˆä»¶ï¼ˆç·¨é›†ï¼‰' : 'æ¡ˆä»¶ï¼ˆæ–°è¦ï¼‰';
    document.getElementById('dlgSub').textContent = currentOrder.order_id ? `order_id: ${currentOrder.order_id}` : '';

    document.getElementById('f_customer').value = currentOrder.customer || '';
    document.getElementById('f_order_no').value = currentOrder.order_no || '';
    document.getElementById('f_vessel').value = currentOrder.vessel || '';
    document.getElementById('f_bl_bk').value = currentOrder.bl_bk || '';

    const fromArea = findAreaForYard(currentOrder.from_yard);
    document.getElementById('f_from_area').value = fromArea;
    updateYards(document.getElementById('f_from_area'), document.getElementById('f_from_yard'));
    document.getElementById('f_from_yard').value = currentOrder.from_yard || '';

    const toArea = findAreaForYard(currentOrder.to_yard);
    document.getElementById('f_to_area').value = toArea;
    updateYards(document.getElementById('f_to_area'), document.getElementById('f_to_yard'));
    document.getElementById('f_to_yard').value = currentOrder.to_yard || '';

    document.getElementById('f_route').value = currentOrder.route || '';
    document.getElementById('f_start_date').value = currentOrder.start_date || '';
    document.getElementById('f_due_date').value = currentOrder.due_date || '';
    document.getElementById('f_memo').value = currentOrder.memo || '';
    document.getElementById('f_voy').value = currentOrder.voy || '';
    document.getElementById('f_inout').value = currentOrder.inout || '';
    document.getElementById('f_chassis').value = currentOrder.chassis || '';
    document.getElementById('f_tax').value = currentOrder.tax || '';
    document.getElementById('f_destination').value = currentOrder.destination || '';

    renderLines();

    document.getElementById('dlg').showModal();
  }

  function readDialogOrderAndLines() {
    const customerShort = document.getElementById('f_customer').value;
    const customerOfficial = (masters && masters.customerMap)
      ? (masters.customerMap[customerShort] || '')
      : '';

    const order = {
      order_id: currentOrder.order_id || '',
      customer: customerShort,
      customerOfficial: customerOfficial,
      order_no: normalizeAlphanumeric(document.getElementById('f_order_no').value),
      vessel: normalizeAlphanumeric(document.getElementById('f_vessel').value),
      bl_bk: normalizeAlphanumeric(document.getElementById('f_bl_bk').value),
      voy: normalizeAlphanumeric(document.getElementById('f_voy').value),
      from_yard: document.getElementById('f_from_yard').value,
      to_yard: document.getElementById('f_to_yard').value,
      inout: document.getElementById('f_inout').value,
      chassis: document.getElementById('f_chassis').value,
      tax: document.getElementById('f_tax').value,
      destination: document.getElementById('f_destination').value,
      route: document.getElementById('f_route').value,
      start_date: document.getElementById('f_start_date').value,
      due_date: document.getElementById('f_due_date').value,
      memo: document.getElementById('f_memo').value
    };

    const lines = currentLines.map(l => ({
      line_id: l.line_id || '',
      size: l.size || '',
      container_type: l.container_type || '',
      qty_total: Number(l.qty_total || 0),
      qty_done: Number(l.qty_done || 0),
      memo: l.memo || '',
      rate: l.rate || ''
    }));

    return { order, lines };
  }

  /************ Events ************/
  // å®‰å…¨ãªã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ç™»éŒ²
  function safeAddEventListener(id, event, handler) {
    const el = document.getElementById(id);
    if (el) {
      el.addEventListener(event, handler);
      console.log(`âœ… ã‚¤ãƒ™ãƒ³ãƒˆç™»éŒ²: ${id} (${event})`);
    } else {
      console.warn(`âŒ è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: ${id}`);
    }
  }

  // å†èª­è¾¼ãƒœã‚¿ãƒ³ã¯å‰Šé™¤ã•ã‚Œã¾ã—ãŸï¼ˆè‡ªå‹•æ›´æ–°ãŒã‚ã‚‹ãŸã‚ï¼‰
  safeAddEventListener('btnNew', 'click', () => openDialog(null));
  safeAddEventListener('btnClose', 'click', () => {
    console.log('é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ');
    document.getElementById('dlg').close();
  });

  // è‡ªå‹•æ›´æ–°ãƒˆã‚°ãƒ«
  safeAddEventListener('autoReloadToggle', 'change', (e) => {
    if (e.target.checked) {
      startAutoReload();
    } else {
      stopAutoReload();
    }
  });

  // æ›´æ–°é–“éš”å¤‰æ›´æ™‚ã«è‡ªå‹•æ›´æ–°ã‚’å†èµ·å‹•
  safeAddEventListener('autoReloadInterval', 'change', () => {
    const toggle = document.getElementById('autoReloadToggle');
    if (toggle.checked) {
      startAutoReload(); // æ–°ã—ã„é–“éš”ã§å†èµ·å‹•
    }
  });

  safeAddEventListener('statusFilter', 'change', () => buildTimeline(allOrders));
  safeAddEventListener('routeFilterSel', 'change', () => buildTimeline(allOrders));
  safeAddEventListener('customerFilterSel', 'change', () => buildTimeline(allOrders));
  safeAddEventListener('includeOldDone', 'change', () => reload().catch(alert));

  safeAddEventListener('f_from_area', 'change', () => {
    updateYards(document.getElementById('f_from_area'), document.getElementById('f_from_yard'));
  });
  safeAddEventListener('f_to_area', 'change', () => {
    updateYards(document.getElementById('f_to_area'), document.getElementById('f_to_yard'));
  });

  // å…¥åŠ›æ­£è¦åŒ–ã‚¤ãƒ™ãƒ³ãƒˆ
  safeAddEventListener('f_order_no', 'input', (e) => {
    e.target.value = normalizeAlphanumeric(e.target.value);
  });

  safeAddEventListener('f_vessel', 'input', (e) => {
    // æœ¬èˆ¹åã‚ªãƒ¼ãƒˆã‚³ãƒ³ãƒ—ãƒªãƒ¼ãƒˆã®ãŸã‚å…¥åŠ›åˆ¶å¾¡ã¯è¡Œã‚ãªã„
  });

  safeAddEventListener('f_bl_bk', 'input', (e) => {
    e.target.value = normalizeAlphanumeric(e.target.value);
  });

  safeAddEventListener('f_voy', 'input', (e) => {
    e.target.value = normalizeAlphanumeric(e.target.value);
  });

  safeAddEventListener('btnAddLine', 'click', () => {
    addLine();
    renderLines();
  });

  safeAddEventListener('btnSave', 'click', async () => {
    console.log('ä¿å­˜ãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ');
    try {
      const { order, lines } = readDialogOrderAndLines();

      // å¿…é ˆãƒã‚§ãƒƒã‚¯
      if (!order.customer) throw new Error('ä¾é ¼ä¸»ãŒæœªé¸æŠã§ã™');
      if (!order.order_no) throw new Error('å—æ³¨ç•ªå·ãŒæœªå…¥åŠ›ã§ã™');
      if (!order.from_yard) throw new Error('æ¬å‡ºãƒ¤ãƒ¼ãƒ‰ãŒæœªé¸æŠã§ã™');
      if (!order.to_yard) throw new Error('æ¬å…¥ãƒ¤ãƒ¼ãƒ‰ãŒæœªé¸æŠã§ã™');
      if (!order.due_date) throw new Error('æœŸé™æ—¥ãŒæœªå…¥åŠ›ã§ã™');
      
      // æ—¥ä»˜ãƒã‚§ãƒƒã‚¯
      const sd = document.getElementById('f_start_date').value;
      const dd = document.getElementById('f_due_date').value;
      const startYmd = sd || dd;
      const dueYmd = dd;

      if (startYmd && dueYmd && startYmd > dueYmd) {
        throw new Error('é–‹å§‹æ—¥ãŒæœŸé™æ—¥ã‚ˆã‚Šå¾Œã«ãªã£ã¦ã„ã¾ã™ã€‚é–‹å§‹æ—¥ï¼æœŸé™æ—¥ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
      }

      if (!lines.length) throw new Error('å†…è¨³ãŒã‚ã‚Šã¾ã›ã‚“');
      
      for (const ln of lines) {
        if (!ln.size) throw new Error('å†…è¨³ã®ã‚µã‚¤ã‚ºãŒæœªé¸æŠã®è¡ŒãŒã‚ã‚Šã¾ã™');
        if (!ln.container_type) throw new Error('å†…è¨³ã®ç¨®é¡ãŒæœªé¸æŠã®è¡ŒãŒã‚ã‚Šã¾ã™');
        if (ln.qty_total < 0) throw new Error('å†…è¨³ã®ç·æœ¬æ•°ã¯0ä»¥ä¸Šã§å…¥åŠ›ã—ã¦ãã ã•ã„');
        
        // å®Œäº†æ•°ãƒã‚§ãƒƒã‚¯
        const doneQty = Number(ln.qty_done || 0);
        if (doneQty > 0 && ln.qty_total < doneQty) {
          throw new Error(
            `${ln.size}/${ln.container_type}: å®Œäº†æ¸ˆã¿${doneQty}æœ¬ãŒã‚ã‚Šã¾ã™ã€‚` +
            `${doneQty}æœ¬æœªæº€ã«ã¯è¨­å®šã§ãã¾ã›ã‚“ã€‚`
          );
        }
      }
      
      const total = lines.reduce((a, b) => a + Number(b.qty_total || 0), 0);
      if (total <= 0) throw new Error('å†…è¨³ã®åˆè¨ˆæœ¬æ•°ãŒ0ã§ã™');

      console.log('[ä¿å­˜] ãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡:', { order, lines });
      await api('upsertOrder', { order, lines });
      console.log('[ä¿å­˜] å®Œäº†');

      document.getElementById('dlg').close();
      await reload();
      alert('ä¿å­˜ã—ã¾ã—ãŸã€‚');
    } catch (e) {
      alert(e.message);
    }
  });

  /************ Boot ************/
  initDefaults();
  (async () => {
    try {
      await loadMasters();
      await reload();
    } catch (err) {
      console.error(err);
      alert('åˆæœŸãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n' + (err && (err.stack || err.message) ? (err.stack || err.message) : String(err)));
    }
  })();
  
  (function initSplitter(){
    const left = document.getElementById('left');
    const splitter = document.getElementById('splitter');

    const MIN = 220;
    const MAX = 520;
    const KEY = 'pf_left_width';

    const saved = Number(localStorage.getItem(KEY) || '');
    if (saved) left.style.width = saved + 'px';

    let dragging = false;
    let startX = 0;
    let startW = 0;

    splitter.addEventListener('mousedown', (e) => {
      dragging = true;
      startX = e.clientX;
      startW = left.getBoundingClientRect().width;
      document.body.style.cursor = 'col-resize';
      document.body.style.userSelect = 'none';
      e.preventDefault();
    });

    window.addEventListener('mousemove', (e) => {
      if (!dragging) return;
      const dx = e.clientX - startX;
      let w = startW + dx;
      w = Math.max(MIN, Math.min(MAX, w));
      left.style.width = w + 'px';
      localStorage.setItem(KEY, String(w));
      if (timeline) timeline.redraw();
    });

    window.addEventListener('mouseup', () => {
      if (!dragging) return;
      dragging = false;
      document.body.style.cursor = '';
      document.body.style.userSelect = '';
    });
  })();
  

// ========================================
// æœ¬èˆ¹åã‚ªãƒ¼ãƒˆã‚³ãƒ³ãƒ—ãƒªãƒ¼ãƒˆ
// ========================================
let vesselList = [];

function setupVesselAutocomplete() {
  const input = document.getElementById('f_vessel');
  if (!input) return;
  
  const listId = 'vesselAutocomplete';
  let list = document.getElementById(listId);
  
  if (!list) {
    list = document.createElement('div');
    list.id = listId;
    list.style.cssText = 'position:absolute;top:100%;left:0;right:0;background:white;border:1px solid #bae6fd;max-height:200px;overflow-y:auto;z-index:1000;display:none;box-shadow:0 4px 12px rgba(0,0,0,0.1);';
    
    const parent = input.parentElement;
    parent.style.position = 'relative';
    parent.appendChild(list);
  }
  
  input.setAttribute('autocomplete', 'off');
  input.addEventListener('input', function() {
    const value = this.value.toUpperCase();
    if (!value) { list.style.display='none'; return; }
    
    const filtered = vesselList.filter(v => v.toUpperCase().includes(value));
    if (!filtered.length) { list.style.display='none'; return; }
    
    list.innerHTML = '';
    filtered.forEach(vessel => {
      const item = document.createElement('div');
      item.style.cssText = 'padding:10px;cursor:pointer;';
      item.textContent = vessel;
      item.onmouseover = () => item.style.backgroundColor='#e0f2fe';
      item.onmouseout = () => item.style.backgroundColor='';
      item.onclick = () => { input.value=vessel; list.style.display='none'; };
      list.appendChild(item);
    });
    list.style.display='block';
  });
  
  document.addEventListener('click', (e) => {
    if (!input.contains(e.target) && !list.contains(e.target)) list.style.display='none';
  });
}

// ========================================
// BL/BKè‡ªå‹•å¤‰æ›
// ========================================
function setupBlBkFormat() {
  const input = document.getElementById('blBk');
  if (!input) return;
  
  input.addEventListener('blur', function() {
    let v = this.value;
    v = v.replace(/[ã-ã‚“ã‚¡-ãƒ¶ãƒ¼ä¸€-é¾ ã€…]/g, '');
    v = v.replace(/[ï¼¡-ï¼ºï½-ï½šï¼-ï¼™]/g, s => String.fromCharCode(s.charCodeAt(0)-0xFEE0));
    this.value = v.toUpperCase();
  });
}

// åˆæœŸåŒ–
window.addEventListener('DOMContentLoaded', function() {
  setupVesselAutocomplete();
  setupBlBkFormat();
});


</script>
</body>
</html>
